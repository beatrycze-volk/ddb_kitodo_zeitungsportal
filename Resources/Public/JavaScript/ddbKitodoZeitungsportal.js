"use strict";
/**
 * (c) Kitodo. Key to digital objects e.V. <contact@kitodo.org>
 *
 * This file is part of the Kitodo and TYPO3 projects.
 *
 * @license GNU General Public License version 3 or later.
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 */if(String.prototype.endsWith===undefined){String.prototype.endsWith=function(e,t){if(e===null||e===""||t!==null&&e.length>t||e.length>this.length){return false}t=t===null||t>this.length||t<=0?this.length:t;var i=this.substr(0,t);return i.lastIndexOf(e)===t-e.length}}var dlfUtils;dlfUtils=dlfUtils||{};dlfUtils.CUSTOM_MIMETYPE={IIIF:"application/vnd.kitodo.iiif",IIP:"application/vnd.netfpx",ZOOMIFY:"application/vnd.kitodo.zoomify"};dlfUtils.RUNNING_INDEX=99999999;dlfUtils.createOl3Layers=function(e,t){var i=t!==undefined?t:null,n=0,o=0,r=[];e.forEach((function(e){var t=void 0;if(n>0){o=n}var l=[o,-e.height,e.width+o,0],s=void 0;if(e.mimetype===dlfUtils.CUSTOM_MIMETYPE.ZOOMIFY){s=new ol.layer.Tile({source:new ol.source.Zoomify({url:e.src,size:[e.width,e.height],crossOrigin:i,offset:[o,0]}),zDirection:-1})}else if(e.mimetype===dlfUtils.CUSTOM_MIMETYPE.IIIF){var a=e.qualities!==undefined&&e.qualities.length>0?$.inArray("color",e.qualities)>=0?"color":$.inArray("native",e.qualities)>=0?"native":"default":"default";s=new ol.layer.Tile({source:new dlfViewerSource.IIIF({url:e.src,version:e.version,size:[e.width,e.height],crossOrigin:i,resolutions:e.resolutions,tileSize:e.tilesize,sizes:e.sizes,format:"jpg",quality:a,supports:e.supports,offset:[o,0],projection:new ol.proj.Projection({code:"kitodo-image",units:"pixels",extent:l})}),zDirection:-1})}else if(e.mimetype===dlfUtils.CUSTOM_MIMETYPE.IIP){t=e.tilesize!==undefined&&e.tilesize.length>0?e.tilesize[0]:256;s=new ol.layer.Tile({source:new dlfViewerSource.IIP({url:e.src,size:[e.width,e.height],crossOrigin:i,tileSize:t,offset:[o,0]}),zDirection:-1})}else{s=new ol.layer.Image({source:new ol.source.ImageStatic({url:e.src,projection:new ol.proj.Projection({code:"kitodo-image",units:"pixels",extent:l}),imageExtent:l,crossOrigin:i})})}r.push(s);n+=e.width}));return r};dlfUtils.createOl3View=function(e){var t=e.reduce((function(e,t){return e+t.width}),0),i=e.reduce((function(e,t){return Math.max(e,t.height)}),0),n=[0,-i,t,0];window.OL3_MAX_ZOOM=8;var o=new ol.proj.Projection({code:"kitodo-image",units:"pixels",extent:n});var r={projection:o,center:ol.extent.getCenter(n),zoom:1,maxZoom:window.OL3_MAX_ZOOM,extent:n};return new ol.View(r)};dlfUtils.exists=function(e){return e!==undefined};dlfUtils.fetchImageData=function(e){var t=new $.Deferred;var i=[],n=0,o=function o(){n+=1;if(n===e.length){t.resolve(i)}};e.forEach((function(e,t){if(e.mimetype===dlfUtils.CUSTOM_MIMETYPE.ZOOMIFY){dlfUtils.fetchZoomifyData(e).done((function(e){i[t]=e;o()}))}else if(e.mimetype===dlfUtils.CUSTOM_MIMETYPE.IIIF){dlfUtils.getIIIFResource(e).done((function(e){i[t]=e;o()}))}else if(e.mimetype===dlfUtils.CUSTOM_MIMETYPE.IIP){dlfUtils.fetchIIPData(e).done((function(e){i[t]=e;o()}))}else{dlfUtils.fetchStaticImageData(e).done((function(e){i[t]=e;o()}))}}));return t};dlfUtils.fetchStaticImageData=function(e){var t=new $.Deferred;var i=new Image;i.onload=function(){var i={src:this.src,mimetype:e.mimetype,width:this.width,height:this.height};t.resolve(i)};i.src=e.url;return t};dlfUtils.getIIIFResource=function e(t){var i=new $.Deferred;var n="GET";$.ajax({url:dlfViewerSource.IIIF.getMetdadataURL(t.url),type:n,dataType:"json"}).done(o);function o(e){var n=t.mimetype,o,r;if(dlfUtils.supportsIIIF(e)){if(e["@context"]&&e["@context"]==="http://iiif.io/api/image/2/context.json"){o=decodeURI(e["@id"]);o=dlfUtils.removeInfoJson(o);r=dlfUtils.buildImageV2(n,o,e);i.resolve(r)}else if(e["@context"]&&(e["@context"]==="http://iiif.io/api/image/3/context.json"||Array.isArray(e["@context"])&&e["@context"].includes("http://iiif.io/api/image/3/context.json"))){o=decodeURI(e["id"]);o=dlfUtils.removeInfoJson(o);r=dlfUtils.buildImageV3(n,o,e);i.resolve(r)}else{o=t.url;o=dlfUtils.removeInfoJson(o);r=dlfUtils.buildImageV1(n,o,e);i.resolve(r)}}}return i};dlfUtils.removeInfoJson=function e(t){if(t.endsWith("/info.json")){t=t.substr(0,t.lastIndexOf("/"))}return t};dlfUtils.supportsIIIF=function e(t){if(t.protocol&&t.protocol==="http://iiif.io/api/image"||t["@context"]&&t["@context"]==="http://iiif.io/api/image/2/context.json"){return true}else if(t["@context"]&&(t["@context"]==="http://library.stanford.edu/iiif/image-api/1.1/context.json"||t["@context"]==="http://iiif.io/api/image/1/context.json")){return true}else if(t.profile&&t.profile.indexOf("http://library.stanford.edu/iiif/image-api/compliance.html")===0){return true}else if(t.identifier&&t.width&&t.height){return true}else return t.documentElement&&"info"===t.documentElement.tagName&&"http://library.stanford.edu/iiif/image-api/ns/"===t.documentElement.namespaceURI};dlfUtils.iiifProfiles={version1:{level0:{supports:[],formats:[],qualities:["native"]},level1:{supports:["regionByPx","sizeByW","sizeByH","sizeByPct"],formats:["jpg"],qualities:["native"]},level2:{supports:["regionByPx","regionByPct","sizeByW","sizeByH","sizeByPct","sizeByConfinedWh","sizeByWh"],formats:["jpg","png"],qualities:["native","color","grey","bitonal"]}},version2:{level0:{supports:[],formats:["jpg"],qualities:["default"]},level1:{supports:["regionByPx","sizeByW","sizeByH","sizeByPct"],formats:["jpg"],qualities:["default"]},level2:{supports:["regionByPx","regionByPct","sizeByW","sizeByH","sizeByPct","sizeByConfinedWh","sizeByDistortedWh","sizeByWh"],formats:["jpg","png"],qualities:["default","bitonal"]}},version3:{level0:{supports:[],formats:["jpg"],qualities:["default"]},level1:{supports:["regionByPx","regionSquare","sizeByW","sizeByH"],formats:["jpg"],qualities:["default"]},level2:{supports:["regionByPx","regionSquare","regionByPct","sizeByW","sizeByH","sizeByPct","sizeByConfinedWh","sizeByWh"],formats:["jpg"],qualities:["default","bitonal"]}},none:{none:{supports:[],formats:[],qualities:[]}}};dlfUtils.buildImageV3=function e(t,i,n){var o=this.getIiifComplianceLevelProfile(n,"version3");return{src:i,version:"version3",width:n.width,height:n.height,tilesize:n.tiles!==undefined?[n.tiles.map((function(e){return e.width}))[0],n.tiles.map((function(e){return e.height===undefined?e.width:e.height}))[0]]:undefined,sizes:n.sizes===undefined?undefined:n.sizes.map((function(e){return[e.width,e.height]})),qualities:["default"].concat(o.qualities).concat(n.extraQualities===undefined?[]:n.extraQualities),formats:["jpg"].concat(o.formats).concat(n.extraFormats===undefined?[]:n.extraFormats),supports:o.supports.concat(n.extraFeatures===undefined?[]:n.extraFeatures),resolutions:n.tiles!==undefined?n.tiles.map((function(e){return e.scaleFactors}))[0]:[],mimetype:t}};dlfUtils.buildImageV2=function e(t,i,n){if(typeof n.profile==="string"){n.profile=[n.profile,{}]}if(n.profile!==undefined&&n.profile.length<2){n.profile.push({})}var o=this.getIiifComplianceLevelProfile(n,"version2");return{src:i,version:"version2",width:n.width,height:n.height,tilesize:n.tiles!==undefined?[n.tiles.map((function(e){return e.width}))[0],n.tiles.map((function(e){return e.height===undefined?e.width:e.height}))[0]]:undefined,sizes:n.sizes===undefined?undefined:n.sizes.map((function(e){return[e.width,e.height]})),qualities:["default"].concat(o.qualities).concat(n.profile[1].qualities===undefined?[]:n.profile[1].qualities),formats:["jpg"].concat(o.formats).concat(n.profile[1].formats===undefined?[]:n.profile[1].formats),supports:o.supports.concat(n.profile[1].supports===undefined?[]:n.profile[1].supports),resolutions:n.tiles!==undefined?n.tiles.map((function(e){return e.scaleFactors}))[0]:[],mimetype:t}};dlfUtils.buildImageV1=function e(t,i,n){var o=this.getIiifComplianceLevelProfile(n,"version1");return{src:i,version:"version1",width:n.width,height:n.height,tilesize:n.tile_width===undefined?n.tile_height===undefined?undefined:n.tile_height:n.tile_height===undefined?n.tile_width:[n.tile_width,n.tile_height],qualities:["native"].concat(o.qualities).concat(n.qualities===undefined?[]:n.qualities),formats:["jpg"].concat(o.formats).concat(n.formats===undefined?[]:n.formats),supports:o.supports,resolutions:n.scale_factors,mimetype:t}};dlfUtils.getIiifComplianceLevelProfile=function(e,t){var i=new RegExp("^https?\\:\\/\\/library\\.stanford\\.edu\\/iiif\\/image-api\\/(1\\.1\\/)?compliance\\.html#level[0-2]$"),n=new RegExp("^https?\\:\\/\\/iiif\\.io\\/api\\/image\\/2\\/level[0-2](\\.json)?$"),o=new RegExp("(^https?\\:\\/\\/iiif\\.io\\/api\\/image\\/3\\/level[0-2](\\.json)?$)|(^level[0-2]$)"),r;if(e.profile===undefined){return dlfUtils.iiifProfiles.none.none}switch(t){case"version1":if(i.test(e.profile)){r=e.profile}break;case"version2":if(typeof e.profile==="string"&&n.test(e.profile)){r=e.profile}if(Array.isArray(e.profile)&&e.profile.length>=1&&typeof e.profile[0]==="string"&&n.test(e.profile[0])){r=e.profile[0]}break;case"version3":if(o.test(e.profile)){r=e.profile}break;default:}if(r!==undefined){r=r.match(/level[0-2](\.json)?$/);r=Array.isArray(r)?r[0].replace(".json",""):undefined;if(r!==undefined){return dlfUtils.iiifProfiles[t][r]}}return dlfUtils.iiifProfiles.none.none};dlfUtils.fetchIIPData=function(e){var t=new $.Deferred;$.ajax({url:dlfViewerSource.IIP.getMetdadataURL(e.url)}).done(i);function i(i,n){if(n!=="success")throw new Error("Problems while fetching ImageProperties.xml");var o=$.extend({src:e.url,mimetype:e.mimetype},dlfViewerSource.IIP.parseMetadata(i));t.resolve(o)}return t};dlfUtils.fetchZoomifyData=function(e){var t=new $.Deferred;$.ajax({url:e.url}).done(i);function i(i,n){if(n!=="success"){throw new Error("Problems while fetching ImageProperties.xml")}var o=$(i).find("IMAGE_PROPERTIES");var r={src:e.url.substring(0,e.url.lastIndexOf("/")+1),width:parseInt(o.attr("WIDTH")),height:parseInt(o.attr("HEIGHT")),tilesize:parseInt(o.attr("TILESIZE")),mimetype:e.mimetype};t.resolve(r)}return t};dlfUtils.getCookie=function(e){var t=document.cookie.match("(^|;) ?"+e+"=([^;]*)(;|$)");if(t){return decodeURI(t[2])}else{return null}};dlfUtils.getUrlParams=function(){if(Object.prototype.hasOwnProperty.call(location,"search")){var e=decodeURIComponent(location.search).slice(1).split("&"),t={};e.forEach((function(e){var i=e.split("=");t[i[0]]=i[1]}));return t}return undefined};dlfUtils.isNull=function(e){return e===null};dlfUtils.isNullEmptyUndefinedOrNoNumber=function(e){return e===null||e===undefined||e===""||isNaN(e)};dlfUtils.isCorsEnabled=function(e){if(!window.location.origin){window.location.origin=window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"")}var t=true;e.forEach((function(e){var i=e.mimetype===dlfUtils.CUSTOM_MIMETYPE.ZOOMIFY?e.url.replace("ImageProperties.xml","TileGroup0/0-0-0.jpg"):e.mimetype===dlfUtils.CUSTOM_MIMETYPE.IIIF?dlfViewerSource.IIIF.getMetdadataURL(e.url):e.mimetype===dlfUtils.CUSTOM_MIMETYPE.IIP?dlfViewerSource.IIP.getMetdadataURL(e.url):e.url;i=window.location.origin+window.location.pathname+"?eID=tx_dlf_pageview_proxy&url="+encodeURIComponent(i)+"&header=2";$.ajax({url:i,async:false}).done((function(e,i){t=i==="success"&&e.indexOf("Access-Control-Allow-Origin")!==-1})).fail((function(e,i){t=false}))}));return t};dlfUtils.isWebGLEnabled=function(){if(!!window.WebGLRenderingContext){var e=document.createElement("canvas"),t=["webgl","experimental-webgl","moz-webgl","webkit-3d"],i=false;for(var n=0;n<t.length;n++){try{i=e.getContext(t[n]);if(i&&typeof i.getParameter==="function"){return true}}catch(e){}}return false}return false};dlfUtils.parseDataDic=function(e){var t=$(e).attr("data-dic"),i=t.split(";"),n={};for(var o=0,r=i.length;o<r;o++){var l=i[o].split(":")[0],s=i[o].split(":")[1];n[l]=s}return n};dlfUtils.setCookie=function(e,t){document.cookie=e+"="+decodeURI(t)+"; path=/"};dlfUtils.scaleToImageSize=function(e,t,i,n,o){var r=void 0;if(i&&n){r={width:i,height:n,scale:t.width/i}}if(r===undefined)return[];var l=r.scale,s=o!==undefined?o:0;for(var a in e){var f=e[a].getGeometry().getCoordinates()[0],d=[];for(var u=0;u<f.length;u++){d.push([s+l*f[u][0],0-l*f[u][1]])}e[a].setGeometry(new ol.geom.Polygon([d]));dlfUtils.RUNNING_INDEX+=1;e[a].setId(""+dlfUtils.RUNNING_INDEX)}return e};dlfUtils.searchFeatureCollectionForText=function(e,t){var i=[];e.forEach((function(e){if(e.get("fulltext")!==undefined){if(e.get("fulltext").toLowerCase().indexOf(t.toLowerCase())>-1)i.push(e)}}));return i.length>0?i:undefined};
/**
 * (c) Kitodo. Key to digital objects e.V. <contact@kitodo.org>
 *
 * This file is part of the Kitodo and TYPO3 projects.
 *
 * @license GNU General Public License version 3 or later.
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 */
ol.Map.prototype.getZoom=function(){return this.getView().getZoom()};ol.Map.prototype.getZoomRange=function(){var e=window.OL3_MAX_ZOOM!==undefined&&!isNaN(window.OL3_MAX_ZOOM)?window.OL3_MAX_ZOOM:18;return[0,e]};ol.Map.prototype.zoom=function(e){var t=this.getView(),i=t.getResolution();this.beforeRender(ol.animation.zoom({resolution:i,duration:500}));t.setZoom(e)};ol.Map.prototype.zoomIn=function(){var e=this.getView(),t=e.getZoom()+1,i=e.getResolution();this.beforeRender(ol.animation.zoom({resolution:i,duration:500}));e.setZoom(t)};ol.Map.prototype.zoomOut=function(){var e=this.getView(),t=e.getZoom()-1,i=e.getResolution();this.beforeRender(ol.animation.zoom({resolution:i,duration:500}));e.setZoom(t)};ol.Map.prototype.zoomTo=function(e,t,i){var n=this.getView(),o=n.getResolution(),r=i!==undefined?i:500;this.beforeRender(ol.animation.zoom({resolution:o,duration:r}));n.setCenter(e);n.setZoom(t)};ol.Map.prototype.rotate=function(e){var t=this.getView(),i=t.getRotation()+e*Math.PI/180,n=t.getCenter();this.beforeRender(ol.animation.rotate({rotation:t.getRotation(),anchor:n,duration:200}));t.rotate(i,n);if(this.ov_view!==null&&this.ov_view!==undefined){this.ov_view.rotate(i)}};ol.Map.prototype.rotateLeft=function(){this.rotate(-5);if(this.ov_view!==null&&this.ov_view!==undefined){this.ov_view.rotate(-5)}};ol.Map.prototype.rotateRight=function(){this.rotate(5);if(this.ov_view!==null&&this.ov_view!==undefined){this.ov_view.rotate(5)}};ol.Map.prototype.resetRotation=function(){this.getView().rotate(0,this.getView().getCenter());if(this.ov_view!==null&&this.ov_view!==undefined){this.ov_view.rotate(0)}};
/**
 * (c) Kitodo. Key to digital objects e.V. <contact@kitodo.org>
 *
 * This file is part of the Kitodo and TYPO3 projects.
 *
 * @license GNU General Public License version 3 or later.
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 */
dlfViewerOL3Styles={};dlfViewerOL3Styles.defaultStyle=function(){return new ol.style.Style({stroke:new ol.style.Stroke({color:"rgba(204,204,204,0.8)",width:3}),fill:new ol.style.Fill({color:"rgba(170,0,0,0.1)"})})};dlfViewerOL3Styles.hoverStyle=function(){return new ol.style.Style({stroke:new ol.style.Stroke({color:"rgba(204,204,204,0.8)",width:1}),fill:new ol.style.Fill({color:"rgba(238,153,0,0.2)"})})};dlfViewerOL3Styles.invisibleStyle=function(){return new ol.style.Style({stroke:new ol.style.Stroke({color:"rgba(170,0,0,0)",width:1})})};dlfViewerOL3Styles.selectStyle=function(){return new ol.style.Style({stroke:new ol.style.Stroke({color:"rgba(170,0,0,0.8)",width:1}),fill:new ol.style.Fill({color:"rgba(238,153,0,0.2)"})})};dlfViewerOL3Styles.textlineStyle=function(){return new ol.style.Style({stroke:new ol.style.Stroke({color:"rgba(170,0,0,1)",width:1})})};dlfViewerOL3Styles.wordStyle=function(){return new ol.style.Style({stroke:new ol.style.Stroke({color:"rgba(238,153,0,0.8)",width:1}),fill:new ol.style.Fill({color:"rgba(238,153,0,0.2)"})})};
/**
 * (c) Kitodo. Key to digital objects e.V. <contact@kitodo.org>
 *
 * This file is part of the Kitodo and TYPO3 projects.
 *
 * @license GNU General Public License version 3 or later.
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 */
var dlfViewerSource=dlfViewerSource||{};dlfViewerSource.findKey=function(e,t,i){for(var n in e){if(t.call(i,e[n],n,e)){return n}}return undefined};Number.isInteger=Number.isInteger||function(e){return typeof e==="number"&&isFinite(e)&&Math.floor(e)===e};Number.isNaN=Number.isNaN||function(e){return e!==null&&(e!==e||+e!==e)};Array.prototype.includes=Array.prototype.includes||function(e){return this.indexOf(e)>-1};dlfViewerSource.tileLoadFunction=function(e,t,i){var n=t.getImage(),o=Array.isArray(e)?e[0]:e,r=Array.isArray(e)?e[1]:e;$(n).on("load",(function(){if(n.naturalWidth>0&&(n.naturalWidth!==o||n.naturalHeight!==r)){var e=document.createElement("canvas");e.width=o;e.height=r;var i=e.getContext("2d");i.drawImage(n,0,0);var l=dlfViewerSource.findKey(t,(function(e){return e===n}));if(l){t[l]=e}}}));n.src=i};dlfViewerSource.IIIF=function(e){var t=e.url.replace(/info.json$/,""),i=e.version||"version2",n=e.format!==undefined?e.format:"jpg",o=e.quality!==undefined?e.quality:e.version==="version1"?"native":"default",r=e.size[0],l=e.size[1],s=e.tileSize,a=e.crossOrigin!==undefined?e.crossOrigin:"*",f=e.offset!==undefined?e.offset:[0,0],d=$.extend([],e.resolutions),u=e.sizes===undefined?[]:e.sizes,h=e.supports===undefined?[]:e.supports,c=u!==undefined&&Array.isArray(u)&&u.length>0,p=s!==undefined&&(Number.isInteger(s)&&s>0||Array.isArray(s)&&s.length>0),g=h!==undefined&&Array.isArray(h)&&(h.includes("regionByPx")||h.includes("regionByPct"))&&(h.includes("sizeByWh")||h.includes("sizeByH")||h.includes("sizeByW")||h.includes("sizeByPct")),v=e.projection,m,x,y;t+=t.lastIndexOf("/")===t.length-1?"":"/";d.sort((function(e,t){return t-e}));if(p||g){if(s!==undefined){if(Number.isInteger(s)&&s>0){m=s;x=s}else if(Array.isArray(s)&&s.length>0){if(s.length===1||s[1]===undefined&&Number.isInteger(s[0])){m=s[0];x=s[0]}if(s.length===2){if(Number.isInteger(s[0])&&Number.isInteger(s[1])){m=s[0];x=s[1]}else if(s[0]===undefined&&Number.isInteger(s[1])){m=s[1];x=s[1]}}}}if(m===undefined||x===undefined){m=256;x=256}if(d.length===0){y=Math.max(Math.ceil(Math.log(r/m)/Math.LN2),Math.ceil(Math.log(l/x)/Math.LN2));for(var w=y;w>=0;w--){d.push(Math.pow(2,w))}}else{var _=Math.max.apply(null,d);y=Math.round(Math.log(_)/Math.LN2)}}else{m=r;x=l;d=[];if(c){u.sort((function(e,t){return e[0]-t[0]}));y=-1;var I=[];for(var w=0;w<u.length;w++){var F=r/u[w][0];if(d.length>0&&d[d.length-1]===F){I.push(w);continue}d.push(F);y++}if(I.length>0){for(var C=0;C<I.length;C++){u.splice(I[C]-C,1)}}}else{d.push(1);u.push([r,l]);y=0}}var b=[f[0],f[1]-l,f[0]+r,f[1]];var U=new ol.tilegrid.TileGrid({extent:b,resolutions:d,origin:ol.extent.getTopLeft(b),tileSize:[m,x]});var T=function(e,s,a){var f,v,w=e[0];if(w>y){return}var _=e[1],I=-e[2]-1,F=d[w];if(_===undefined||Number.isNaN(I)||F===undefined||_<0||Math.ceil(r/F/m)<=_||I<0||Math.ceil(l/F/x)<=I){return}if(g||p){var $=_*m*F,C=I*x*F;var b=m*F,U=x*F,T=m,S=x;if($+b>r){b=r-$}if(C+U>l){U=l-C}if($+m*F>r){T=Math.floor((r-$+F-1)/F)}if(C+x*F>l){S=Math.floor((l-C+F-1)/F)}if($===0&&b===r&&C===0&&U===l){f="full"}else if(!g||h.includes("regionByPx")){f=$+","+C+","+b+","+U}else if(h.includes("regionByPct")){var P=formatPercentage($/r*100),V=formatPercentage(C/l*100),M=formatPercentage(b/r*100),A=formatPercentage(U/l*100);f="pct:"+P+","+V+","+M+","+A}if(i==="version3"&&(!g||h.includes("sizeByWh"))){v=T+","+S}else if(!g||h.includes("sizeByW")){v=T+","}else if(h.includes("sizeByH")){v=","+S}else if(h.includes("sizeByWh")){v=T+","+S}else if(h.includes("sizeByPct")){v="pct:"+formatPercentage(100/F)}}else{f="full";if(c){var L=u[w][0],D=u[w][1];if(i==="version3"){if(L===r&&D===l){v="max"}else{v=L+","+D}}else{if(L===r){v="full"}else{v=L+","}}}else{v=i==="version3"?"max":"full"}}return t+f+"/"+v+"/0/"+o+"."+n};var S={crossOrigin:a,projection:v,tileGrid:U,tileUrlFunction:T};if(ol.has.CANVAS){S.tileLoadFunction=dlfViewerSource.tileLoadFunction.bind(this,[m,x])}return new ol.source.TileImage(S)};dlfViewerSource.IIIF.getMetdadataURL=function(e){var t=e.lastIndexOf("/")+1===e.length?"info.json":"/info.json";return e+t};dlfViewerSource.IIP=function(e){var t=e.url.indexOf("?")>-1?e.url:e.url+"?",i=e.size[0],n=e.size[1],o=e.tileSize!==undefined?e.tileSize:256,r=e.crossOrigin!==undefined?e.crossOrigin:"*",l=e.offset!==undefined?e.offset:[0,0],s=[],a=e.projection;var f=[],d=i,u=n,h=1;while(d>o||u>o){f.push([Math.ceil(d/o),Math.ceil(u/o)]);s.push(h);d>>=1;u>>=1;h+=h}s.push(h);f.push([1,1]);f.reverse();var c=[l[0],l[1]-n,l[0]+i,l[1]];var p=new ol.tilegrid.TileGrid({extent:c,resolutions:s.reverse(),origin:ol.extent.getTopLeft(c),tileSize:o});var g=function(e,i,n){if(e===undefined||e===null){return undefined}else{var o=e[0],r=e[1],l=-e[2]-1,s=l*f[o][0]+r;return t+"&JTL="+o+","+s}};var v={crossOrigin:r,projection:a,tileGrid:p,tileUrlFunction:g};if(ol.has.CANVAS){v.tileLoadFunction=dlfViewerSource.tileLoadFunction.bind(this,o)}return new ol.source.TileImage(v)};dlfViewerSource.IIP.getMetdadataURL=function(e){var t="&obj=IIP,1.0&obj=Max-size&obj=Tile-size&obj=Resolution-number",i=e.indexOf("?")>-1?e:e+"?";return i+t};dlfViewerSource.IIP.parseMetadata=function(e){var t=e.split("Max-size");if(!t[1]){return null}var i=t[1].split(" ");var n=e.split("Tile-size");if(!n[1]){return null}var o=n[1].split(" ");var r=e.split("Resolution-number"),l=parseInt(r[1].substring(1,r[1].length)),s=1,a=[];for(var f=0;f<l;f++){a.push(s);s+=s}var d={width:parseInt(i[0].substring(1,i[0].length)),height:parseInt(i[1]),tilesize:[parseInt(o[0].substring(1,o[0].length)),parseInt(o[1])],resolutions:a};return d};
/**
 * (c) Kitodo. Key to digital objects e.V. <contact@kitodo.org>
 *
 * This file is part of the Kitodo and TYPO3 projects.
 *
 * @license GNU General Public License version 3 or later.
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 */
var dlfAltoParser=function(e,t,i,n){this.image_=dlfUtils.exists(e)?e:undefined;this.width_=dlfUtils.exists(t)?t:undefined;this.height_=dlfUtils.exists(i)?i:undefined;this.offset_=dlfUtils.exists(n)?n:undefined};dlfAltoParser.prototype.generateId_=function(e,t,i,n){var o=isNaN(t)?"0":t;return""+e+"_"+o+"_"+i+"_"+n};dlfAltoParser.prototype.parseAltoFeature_=function(e){var t=e.nodeName.toLowerCase(),i;if(t==="printspace"||t==="textblock"||t==="textline"||e.hasAttribute("WIDTH")){i=this.parseFeatureWithGeometry_(e)}else{var i=new ol.Feature;i.setProperties({type:e.nodeName.toLowerCase()})}if(t==="page"){var n=i.get("width"),o=i.get("height");if(dlfUtils.exists(n)&&dlfUtils.exists(o)&&!dlfUtils.exists(this.width_)&&!dlfUtils.exists(this.height_)){this.width_=n;this.height_=o}i.setProperties({printspace:this.parsePrintSpaceFeature_(e)})}else if(t==="printspace"){var n=i.get("width"),o=i.get("height");if(dlfUtils.exists(n)&&dlfUtils.exists(o)&&!dlfUtils.exists(this.width_)&&!dlfUtils.exists(this.height_)){this.width_=n;this.height_=o}i.setProperties({textblocks:this.parseTextBlockFeatures_(e)})}else if(t==="textblock"){i.setProperties({textlines:this.parseTextLineFeatures_(e)})}else if(t==="textline"){i.setProperties({content:this.parseContentFeatures_(e)})}return i};dlfAltoParser.prototype.parseFeatures=function(e){var t=this.parseXML_(e),i=[],n=$(t).find("Page");for(var o=0;o<n.length;o++){var r=this.parseAltoFeature_(n[o]);r.getStringFeatures=function(){var e=this.get("printspace").get("textblocks"),t=[];e.forEach((function(e){if(e!==undefined&&e.get("textlines").length>0){e.get("textlines").forEach((function(e){if(e!==undefined&&e.get("content").length>0){e.get("content").forEach((function(e){if(e!==undefined&&e.get("type")==="string"){t.push(e)}}))}}))}}));return t};r.getTextblocks=function(){if(this.get("printspace")!==undefined&&this.get("printspace").get("textblocks"))return this.get("printspace").get("textblocks");return[]};r.getTextlines=function(){var e=[];this.getTextblocks().forEach((function(t){e=e.concat(t.get("textlines"))}));return e};i.push(r)}return i};dlfAltoParser.prototype.parseFeatureWithGeometry_=function(e){var t=this.parseGeometry_(e),i=parseInt(e.getAttribute("WIDTH")),n=parseInt(e.getAttribute("HEIGHT")),o=parseInt(e.getAttribute("HPOS")),r=parseInt(e.getAttribute("VPOS")),l=e.nodeName.toLowerCase(),s=this.generateId_(i,n,o,r),a=new ol.Feature(t);a.setId(s);a.setProperties({type:l,width:i,height:n,hpos:o,vpos:r});return a};dlfAltoParser.prototype.parseGeometry_=function(e){var t=parseInt(e.getAttribute("WIDTH")),i=parseInt(e.getAttribute("HEIGHT")),n=parseInt(e.getAttribute("HPOS")),o=parseInt(e.getAttribute("VPOS")),r=n+t,l=o+i,s=[[[n,o],[r,o],[r,l],[n,l],[n,o]]];if(isNaN(t)||isNaN(i))return undefined;if(!dlfUtils.exists(this.image_)||!dlfUtils.exists(this.width_))return new ol.geom.Polygon(s);var a=this.image_.width/this.width_,f=dlfUtils.exists(this.offset_)?this.offset_:0,d=[];for(var u=0;u<s[0].length;u++){d.push([f+a*s[0][u][0],0-a*s[0][u][1]])}return new ol.geom.Polygon([d])};dlfAltoParser.prototype.parsePrintSpaceFeature_=function(e){var t=$(e).find("PrintSpace");if(t.length===0)return;return this.parseAltoFeature_(t[0])};dlfAltoParser.prototype.parseTextBlockFeatures_=function(e){var t=$(e).find("TextBlock"),i=[];for(var n=0;n<t.length;n++){var o=this.parseAltoFeature_(t[n]),r=o.get("textlines"),l="";for(var s=0;s<r.length;s++){l+=r[s].get("fulltext")+"\n"}o.setProperties({fulltext:l});i.push(o)}return i};dlfAltoParser.prototype.parseTextLineFeatures_=function(e){var t=$(e).find("TextLine"),i=[];for(var n=0;n<t.length;n++){var o=this.parseAltoFeature_(t[n]),r=o.get("content"),l="";for(var s=0;s<r.length;s++){l+=r[s].get("fulltext")}o.setProperties({fulltext:l});i.push(o)}return i};dlfAltoParser.prototype.parseContentFeatures_=function(e){var t=$(e).children(),i=[];for(var n=0;n<t.length;n++){var o=this.parseFeatureWithGeometry_(t[n]),r="";switch(t[n].nodeName.toLowerCase()){case"string":r=t[n].getAttribute("CONTENT");break;case"sp":r=" ";break;case"hyp":r="-";break;default:r=""}o.setProperties({fulltext:r});i.push(o)}return i};dlfAltoParser.prototype.parseXML_=function(e){if(typeof e==="string"||e instanceof String){return $.parseXML(e)}return e};
/**
 * (c) Kitodo. Key to digital objects e.V. <contact@kitodo.org>
 *
 * This file is part of the Kitodo and TYPO3 projects.
 *
 * @license GNU General Public License version 3 or later.
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 */
var DlfIiifAnnotationParser=function(e,t,i,n){this.image_=dlfUtils.exists(e)?e:undefined;this.width_=dlfUtils.exists(t)?t:undefined;this.height_=dlfUtils.exists(i)?i:undefined;this.offset_=dlfUtils.exists(n)?n:undefined};DlfIiifAnnotationParser.prototype.generateId_=function(e,t,i,n){var o=isNaN(t)?"0":t;return"anno_"+e+"_"+o+"_"+i+"_"+n};DlfIiifAnnotationParser.prototype.parseAnnotation=function(e){var t=this.parseGeometry(e),i=this.getXYWHForAnnotation(e),n=this.generateId_(i.width,i.height,i.x1,i.y1),o=new ol.Feature(t);o.setId(n);o.setProperties({type:"annotation",width:i.width,height:i.height,x1:i.x1,y1:i.y1,x2:i.x2,y2:i.y2,content:e.resource.chars});return o};DlfIiifAnnotationParser.prototype.parseAnnotationList=function(e,t){var i,n,o,r,l=[];for(var s=0;s<e.resources.length;s++){var a=e.resources[s];var f=DlfIiifAnnotationParser.getTargetIdentifierWithoutFragment(a.on);if(t!==f){continue}var d=this.parseAnnotation(a);i=i===undefined?d.get("x1"):i>d.get("x1")?d.get("x1"):i;n=n===undefined?d.get("x2"):n<d.get("x2")?d.get("x2"):n;o=o===undefined?d.get("y1"):o>d.get("y1")?d.get("y1"):o;r=r===undefined?d.get("y2"):r<d.get("y2")?d.get("y2"):r;l.push(d)}var u=n-i,h=r-o,c=[[[i,o],[n,o],[n,r],[i,r],[i,o]]],p=this.generateId_(u,h,i,o),g=this.image_.width/this.width_,v=[];for(var s=0;s<c[0].length;s++){v.push([g*c[0][s][0],0-g*c[0][s][1]])}var m=new ol.geom.Polygon([v]),x=new ol.Feature(m);x.setId(p);x.setProperties({type:"annotationList",label:e.label!==null?e.label:"",width:n-i+1,height:r-o+1,x1:i,y1:o,x2:n,y2:r,annotations:l});x.getAnnotations=function(){return l};return x};DlfIiifAnnotationParser.prototype.parseGeometry=function(e){var t=this.getXYWHForAnnotation(e),i=[[[t.x1,t.y1],[t.x2,t.y1],[t.x2,t.y2],[t.x1,t.y2],[t.x1,t.y1]]];if(isNaN(t.width)||isNaN(t.height))return undefined;if(!dlfUtils.exists(this.image_)||!dlfUtils.exists(this.width_))return new ol.geom.Polygon(i);var n=this.image_.width/this.width_,o=dlfUtils.exists(this.offset_)?this.offset_:0,r=[];for(var l=0;l<i[0].length;l++){r.push([o+n*i[0][l][0],0-n*i[0][l][1]])}return new ol.geom.Polygon([r])};DlfIiifAnnotationParser.prototype.getXYWHForAnnotation=function(e){var t=e.on.indexOf("#xywh="),i=t>-1?e.on.substr(t+6).split(","):undefined;if(i===undefined)return{x1:0,y1:0,width:this.width,height:this.height,x2:this.width-1,y2:this.height-1};return{x1:parseInt(i[0]),y1:parseInt(i[1]),width:parseInt(i[2]),height:parseInt(i[3]),x2:parseInt(i[0])+parseInt(i[2])-1,y2:parseInt(i[1])+parseInt(i[3])-1}};DlfIiifAnnotationParser.getTargetIdentifierWithoutFragment=function(e){if(e===null){return null}return e.split("#")[0]};
/**
 * (c) Kitodo. Key to digital objects e.V. <contact@kitodo.org>
 *
 * This file is part of the Kitodo and TYPO3 projects.
 *
 * @license GNU General Public License version 3 or later.
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 */
if(jQuery.fn.scrollTo===undefined){jQuery.fn.scrollTo=function(e,t){var i=$(e).parent().height()/2;$(this).animate({scrollTop:$(this).scrollTop()-$(this).offset().top+$(e).offset().top-i},t===undefined?1e3:t);return this}}function DlfAnnotationControl(e,t,i){this.map=e;this.image=t;this.annotationContainers=i.annotationContainers;this.canvas=i.canvas;this.annotationData=undefined;this.dic=$("#tx-dlf-tools-annotations").length>0&&$("#tx-dlf-tools-annotations").attr("data-dic")?dlfUtils.parseDataDic($("#tx-dlf-tools-annotations")):{"annotations-on":"Display Annotations","annotations-off":"Hide Annotations"};this.layers_={annotationList:new ol.layer.Vector({source:new ol.source.Vector,style:dlfViewerOL3Styles.defaultStyle()}),annotation:new ol.layer.Vector({source:new ol.source.Vector,style:dlfViewerOL3Styles.invisibleStyle()}),select:new ol.layer.Vector({source:new ol.source.Vector,style:dlfViewerOL3Styles.selectStyle()}),hoverAnnotationList:new ol.layer.Vector({source:new ol.source.Vector,style:dlfViewerOL3Styles.hoverStyle()}),hoverAnnotation:new ol.layer.Vector({source:new ol.source.Vector,style:dlfViewerOL3Styles.textlineStyle()})};this.handlers={mapClick:$.proxy((function(e){var t=this.map.forEachFeatureAtPixel(e["pixel"],(function(e,t){if(e.get("type")==="annotationList"){return e}}));if(t===undefined){this.layers_.select.getSource().clear();this.selectedFeature_=undefined;this.showAnnotationText(undefined);return}if(this.selectedFeature_){this.layers_.select.getSource().removeFeature(this.selectedFeature_)}if(t){this.layers_.hoverAnnotationList.getSource().clear();this.layers_.select.getSource().addFeature(t)}this.selectedFeature_=t;if(dlfUtils.exists(t)){this.showAnnotationText([t])}}),this),mapHover:$.proxy((function(e){if(e["dragging"]){return}var t=this.layers_.hoverAnnotation.getSource(),i=this.layers_.hoverAnnotationList.getSource(),n=this.layers_.select.getSource(),o=this.map,r,l;o.forEachFeatureAtPixel(e["pixel"],(function(e,t){if(e.get("type")==="annotationList"){r=e}if(e.get("type")==="annotation"){l=e}}));var s=n.getFeatures().length>0?n.getFeatures()[0]:undefined,a=i.getFeatures().length>0?i.getFeatures()[0]:undefined,f=s!==undefined&&r!==undefined&&s.getId()===r.getId()?true:false,d=a!==undefined&&r!==undefined&&a.getId()===r.getId()?true:false;if(!d&&!f){i.clear();if(r){i.addFeature(r)}}var a=t.getFeatures().length>0?t.getFeatures()[0]:undefined,d=a!==undefined&&l!==undefined&&a.getId()===l.getId()?true:false;if(!d){if(a){var u=$("#"+a.getId());if(u.hasClass("highlight")){u.removeClass("highlight")}t.clear()}if(l){var h=$("#"+l.getId());if(h.length>0&&!h.hasClass("highlight")){h.addClass("highlight");$("#tx-dlf-annotationselection").scrollTo(h,50);t.addFeature(l)}}}}),this)};var n=$("#tx-dlf-tools-annotations");if(n.length>0){var o=$.proxy((function(e){e.preventDefault();if($(e.target).hasClass("active")){this.deactivate();return}this.activate()}),this);n.on("click",o);n.on("touchstart",o)}this.selectedFeature_=undefined;$("#tx-dlf-tools-annotations").text(this.dic["annotations-on"]).attr("title",this.dic["annotations-on"]);if(dlfUtils.getCookie("tx-dlf-pageview-annotation-select")==="enabled"){this.activate(n)}}DlfAnnotationControl.prototype.showAnnotationText=function(e){var t=e===undefined?this.annotationData:e;if(t!==undefined){$("#tx-dlf-annotationselection").children().remove();for(var i=0;i<t.length;i++){var n=t[i],o=n.get("annotations"),r;if(n.get("label")!==""){r=$('<span class="annotation-list-label"/>');r.text(n.get("label"));$("#tx-dlf-annotationselection").append(r)}for(var l=0;l<o.length;l++){var s=$('<span class="annotation" id="'+o[l].getId()+'"/>');s.text(o[l].get("content"));$("#tx-dlf-annotationselection").append(s);$("#tx-dlf-annotationselection").append(" ")}$("#tx-dlf-annotationselection").append("<br /><br />")}}};DlfAnnotationControl.prototype.activate=function(){var e=$("#tx-dlf-tools-annotations");if(this.annotationData===undefined){this.annotationData=this.fetchAnnotationContainersFromServer(this.annotationContainers,this.image,this.canvas);if(this.annotationData!==undefined){this.layers_.annotationList.getSource().addFeatures(this.annotationData);for(var t=0;t<this.annotationData.length;t++){this.layers_.annotation.getSource().addFeatures(this.annotationData[t].getAnnotations())}if(this.annotationData.length>0){this.showAnnotationText(this.annotationData)}}}this.enableAnnotationSelect();dlfUtils.setCookie("tx-dlf-pageview-annotation-select","enabled");$(e).addClass("active");$(this).trigger("activate-annotations",this)};DlfAnnotationControl.prototype.deactivate=function(){var e=$("#tx-dlf-tools-annotations");this.disableAnnotationSelect();dlfUtils.setCookie("tx-dlf-pageview-annotation-select","disabled");$(e).removeClass("active");$(this).trigger("deactivate-annotations",this)};DlfAnnotationControl.prototype.disableAnnotationSelect=function(){this.map.un("click",this.handlers.mapClick);this.map.un("pointermove",this.handlers.mapHover);for(var e in this.layers_){if(this.layers_.hasOwnProperty(e)){this.map.removeLayer(this.layers_[String(e)])}}var t="fulltext-visible";$("#tx-dlf-tools-annotations").removeClass(t).text(this.dic["annotations-on"]).attr("title",this.dic["annotations-on"]);$("#tx-dlf-annotationselection").removeClass(t);$("#tx-dlf-annotationselection").hide();$("body").removeClass(t)};DlfAnnotationControl.prototype.enableAnnotationSelect=function(e,t){this.map.on("click",this.handlers.mapClick);this.map.on("pointermove",this.handlers.mapHover);for(var i in this.layers_){if(this.layers_.hasOwnProperty(i)){this.map.addLayer(this.layers_[String(i)])}}var n="fulltext-visible";$("#tx-dlf-tools-annotations").addClass(n).text(this.dic["annotations-off"]).attr("title",this.dic["annotations-off"]);$("#tx-dlf-annotationselection").addClass(n);$("#tx-dlf-annotationselection").show();$("body").addClass(n)};DlfAnnotationControl.prototype.fetchAnnotationContainersFromServer=function(e,t,i,n){var o=[],r;r=new DlfIiifAnnotationParser(t,i.width,i.height,n);e.forEach((function(e){var t;var n=$.ajax({url:e.uri,async:false});t=n.responseJSON!==null?n.responseJSON:n.responseText!==null?$.parseJSON(n.responseText):null;if(t.label===undefined){t.label=e.label}o.push(r.parseAnnotationList(t,i.id))}));return o};
/**
 * (c) Kitodo. Key to digital objects e.V. <contact@kitodo.org>
 *
 * This file is part of the Kitodo and TYPO3 projects.
 *
 * @license GNU General Public License version 3 or later.
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 */
dlfViewerImageManipulationControl=function(e){this.dic=$("#tx-dlf-tools-imagetools").length>0&&$("#tx-dlf-tools-imagetools").attr("data-dic")?dlfUtils.parseDataDic($("#tx-dlf-tools-imagetools")):{"imagemanipulation-on":"Activate image manipulation","imagemanipulation-off":"Deactivate image manipulation",saturation:"Saturation",hue:"Hue",brightness:"Brightness",contrast:"Contrast",reset:"Reset",invert:"Color inverting",parentContainer:".tx-dlf-imagemanipulationtool"};this.layers=e.layers;this.baseMap_=e.map;this.map_=undefined;this.view_=e.view;this.anchor_=$("<a/>",{href:"#image-manipulation",text:this.dic["imagemanipulation-on"],title:this.dic["imagemanipulation-on"]});$(e.controlTarget).append(this.anchor_);this.toolContainerEl_=dlfUtils.exists(e.toolContainer)?e.toolContainer:$(this.dic["parentContainer"])[0];var t=$.proxy((function(e){e.preventDefault();if($(e.target).hasClass("active")){this.deactivate();return}this.activate()}),this);$(this.anchor_).on("click",t);$(this.anchor_).on("touchstart",t);var i={brightness:1,contrast:1,hue:0,saturation:0};this.filters_=$.extend({},i);this.filterUpdated_=false;this.handler_={postcomposeImageFilter:$.proxy((function(e){var t=e["glContext"],i=$("#"+this.map_.getTargetElement().id+" canvas.ol-unselectable")[0];if(t!==undefined&&t!==null){var n=t.getGL();if(this.filterUpdated_){glif.reset();for(var o in this.filters_){glif.addFilter(o,this.filters_[String(o)])}this.filterUpdated_=false}glif.apply(n,i);t.useProgram(undefined)}}),this),resetFilter:$.proxy((function(e){if(this.filters_.hasOwnProperty("invert")){$("#invert-filter").click()}var t=$(".slider.slider-imagemanipulation");for(var n=0;n<t.length;n++){var o=t[n],r=o.getAttribute("data-type"),l=i[String(r)];$(o).slider("value",l)}}),this)}};dlfViewerImageManipulationControl.prototype.activate=function(){$.when($(this.baseMap_.getTargetElement()).hide()).done($.proxy((function(){if(!dlfUtils.exists(this.map_)){this.createMap_()}$(this.map_.getTargetElement()).show();$(this).trigger("activate-imagemanipulation",this.map_)}),this));$(this.anchor_).addClass("active").text(this.dic["imagemanipulation-off"]).attr("title",this.dic["imagemanipulation-off"]);if(!dlfUtils.exists(this.sliderContainer_)){this.createFilters_()}$(this.sliderContainer_).show().addClass("open");if(this.map_!==undefined)this.map_.on("postcompose",this.handler_.postcomposeImageFilter)};dlfViewerImageManipulationControl.prototype.createFilters_=function(){var e=$('<div class="image-manipulation ol-unselectable"></div>');$(this.toolContainerEl_).append(e);this.sliderContainer_=$('<div class="slider-container"></div>');$(e).append(this.sliderContainer_);var t=this.createSlider_("slider-contrast","horizontal","contrast",[1,0,2,.01],this.dic["contrast"],(function(e){return parseInt(e*100-100)})),i=this.createSlider_("slider-saturation","horizontal","saturation",[0,-1,1,.01],this.dic["saturation"],(function(e){return parseInt(e*100)})),n=this.createSlider_("slider-brightness","horizontal","brightness",[1,0,2,.1],this.dic["brightness"],(function(e){return parseInt(e*100-100)})),o=this.createSlider_("slider-hue","horizontal","hue",[0,-180,180,5],this.dic["hue"],(function(e){return parseInt(e)}));$(this.sliderContainer_).append(t);$(this.sliderContainer_).append(i);$(this.sliderContainer_).append(n);$(this.sliderContainer_).append(o);var r="invert-filter";$(this.sliderContainer_).append($('<div class="checkbox"><label><input type="checkbox" id="'+r+'">'+this.dic["invert"]+"</label></div>"));$("#"+r).on("click",$.proxy((function(e){if(e.target.checked===true&&!this.filters_.hasOwnProperty("invert")){this.filters_["invert"]=true}else{if(this.filters_.hasOwnProperty("invert")){delete this.filters_["invert"]}}this.filterUpdated_=true;this.layers[0].changed()}),this));var l=$('<button class="reset-btn" title="'+this.dic["reset"]+'">'+this.dic["reset"]+"</button>");$(this.sliderContainer_).append(l);$(l).on("click",this.handler_.resetFilter)};dlfViewerImageManipulationControl.prototype.createMap_=function(){var e=$('<div id="tx-dlf-map-manipulate" class="tx-dlf-map"></div>');$(this.baseMap_.getTargetElement().parentElement).append(e);this.map_=new ol.Map({layers:this.layers,target:e[0].id,controls:[],interactions:[new ol.interaction.DragRotate,new ol.interaction.DragPan,new ol.interaction.DragZoom,new ol.interaction.PinchRotate,new ol.interaction.PinchZoom,new ol.interaction.MouseWheelZoom,new ol.interaction.KeyboardPan,new ol.interaction.KeyboardZoom,new ol.interaction.DragRotateAndZoom],keyboardEventTarget:document,view:this.view_,renderer:"webgl"});var t=function(e,t){var i=e.getRotation()!==t.getView().getRotation();var n=e.getResolution()!==t.getView().getResolution();var o=e.getCenter()!==t.getView().getCenter();if(i||n||o){t.zoomTo(e.getCenter(),e.getZoom(),50);t.getView().rotate(e.getRotation())}},i=function(e){t(e.target,this)};$(this).on("activate-imagemanipulation",$.proxy((function(e,n){this.baseMap_.getView().on("change:resolution",i,this.map_);this.baseMap_.getView().on("change:rotation",i,this.map_);t(this.baseMap_.getView(),this.map_)}),this));$(this).on("deactivate-imagemanipulation",$.proxy((function(e,n){this.baseMap_.getView().un("change:resolution",i,this.map_);this.baseMap_.getView().un("change:rotation",i,this.map_);t(this.map_.getView(),this.baseMap_)}),this))};dlfViewerImageManipulationControl.prototype.createSlider_=function(e,t,i,n,o,r){var l=dlfUtils.exists("opt_title")?o:"",s=$('<div class="slider slider-imagemanipulation '+e+'" title="'+l+'" data-type="'+i+'"></div>'),a=dlfUtils.exists(n)?n[1]:0,f=dlfUtils.exists(n)?n[2]:100,d=dlfUtils.exists(n)?n[3]:1,u=dlfUtils.exists(n)?n[0]:100;var h=$.proxy((function(e,n){var o=n["value"],l=this.layers[0],s=p[0],d=dlfUtils.exists(r)?r(o):o+"%";if(t==="vertical"){var u=100-(o-a)/(f-a)*100;s.style.top=u+"%";s.innerHTML=d;return}var h=(o-a)/(f-a)*100;s.style.left=h+"%";s.innerHTML=d;this.filters_[i]=o;this.filterUpdated_=true;l.changed()}),this);$(s).slider({min:a,max:f,value:u,animate:"slow",orientation:t,step:d,slide:h,change:h});var c=dlfUtils.exists(r)&&dlfUtils.exists(n)?r(n[0]):"100%",p=$('<div class="tooltip value '+e+'">'+c+"</div>");$(s).append(p);return s};dlfViewerImageManipulationControl.prototype.deactivate=function(){if(dlfUtils.exists(this.map_)){$(this.map_.getTargetElement()).hide()}$(this.baseMap_.getTargetElement()).show();$(this.anchor_).removeClass("active").text(this.dic["imagemanipulation-on"]).attr("title",this.dic["imagemanipulation-on"]);$(this.sliderContainer_).hide().removeClass("open");if(this.map_!==undefined)this.map_.un("postcompose",this.handler_.postcomposeImageFilter);$(this).trigger("deactivate-imagemanipulation")};dlfViewerImageManipulationControl.prototype.isActive=function(){return $(this.anchor_).hasClass("active")};var dlfViewerFullTextDownloadControl=function(e,t,i){this.map=e;this.image=t;this.url=i;var n=$("#tx-dlf-tools-fulltextdownload");if(n.length>0){var o=$.proxy((function(e){e.preventDefault();this.downloadFullTextFile()}),this);n.on("click",o);n.on("touchstart",o)}};dlfViewerFullTextDownloadControl.prototype.downloadFullTextFile=function(){var e=$("#tx-dlf-tools-fulltextdownload");var t=$("<a/>");t.attr("id","downloadFile");t.attr("href","data:text/plain;charset=utf-8,"+encodeURIComponent(this.createFullTextFile()));t.attr("download","fulltext.txt");t.insertAfter(e);$("#downloadFile").get(0).click();$("#downloadFile").remove()};dlfViewerFullTextDownloadControl.prototype.createFullTextFile=function(){var e=dlfFullTextUtils.fetchFullTextDataFromServer(this.url,this.image);var t=e.getTextblocks();var i="";if(t!==undefined){for(feature of t){var n=feature.get("textlines");for(textLine of n){i=i.concat(this.appendTextLine(textLine))}i=i.concat("\n\n")}}return i};dlfViewerFullTextDownloadControl.prototype.appendTextLine=function(e){var t="";var i=e.get("content");for(item of i){var n=item.get("fulltext");var o=n.split(/\n/g);for(const[e,i]of o.entries()){t=t.concat(i);if(e<o.length-1){t=t.concat("\n")}}}return t.concat(t)};
/**
 * (c) Kitodo. Key to digital objects e.V. <contact@kitodo.org>
 *
 * This file is part of the Kitodo and TYPO3 projects.
 *
 * @license GNU General Public License version 3 or later.
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 */
jQuery.fn.scrollTo=function(e,t){var i=$(e).parent().height()/2;$(this).animate({scrollTop:$(this).scrollTop()-$(this).offset().top+$(e).offset().top-i},t===undefined?1e3:t);return this};var dlfViewerFullTextControl=function(e,t,i){this.map=e;this.image=t;this.url=i;this.dic=$("#tx-dlf-tools-fulltext").length>0&&$("#tx-dlf-tools-fulltext").attr("data-dic")?dlfUtils.parseDataDic($("#tx-dlf-tools-fulltext")):{fulltext:"Fulltext","fulltext-on":"Activate Fulltext","fulltext-off":"Deactivate Fulltext","activate-full-text-initially":"0","full-text-scroll-element":"html, body"};this.activateFullTextInitially=this.dic["activate-full-text-initially"]==="1"?1:0;this.fullTextScrollElement=this.dic["full-text-scroll-element"];this.fulltextData_=undefined;this.layers_={textblock:new ol.layer.Vector({source:new ol.source.Vector,style:dlfViewerOL3Styles.defaultStyle()}),textline:new ol.layer.Vector({source:new ol.source.Vector,style:dlfViewerOL3Styles.invisibleStyle()}),select:new ol.layer.Vector({source:new ol.source.Vector,style:dlfViewerOL3Styles.selectStyle()}),hoverTextblock:new ol.layer.Vector({source:new ol.source.Vector,style:dlfViewerOL3Styles.hoverStyle()}),hoverTextline:new ol.layer.Vector({source:new ol.source.Vector,style:dlfViewerOL3Styles.textlineStyle()})};this.selectedFeature_=undefined;this.positions={};this.element=undefined;this.lastHeight;this.handlers_={mapClick:$.proxy((function(e){var t=this.map.forEachFeatureAtPixel(e["pixel"],(function(e,t){if(e.get("type")==="textblock"){return e}}));if(t===undefined){this.layers_.select.getSource().clear();this.selectedFeature_=undefined;this.showFulltext(undefined);return}this.handleLayersForClick(t);this.selectedFeature_=t;if(dlfUtils.exists(t)){this.showFulltext([t])}}),this),mapHover:$.proxy((function(e){if(e["dragging"]){return}var t=this.layers_.hoverTextblock.getSource(),i=this.layers_.hoverTextline.getSource(),n=this.layers_.select.getSource(),o=this.map,r,l;o.forEachFeatureAtPixel(e["pixel"],(function(e,t){if(e.get("type")==="textblock"){r=e}if(e.get("type")==="textline"){l=e}}));this.handleTextBlockElements(r,n,t);this.handleTextLineElements(l,i)}),this)};this.changeActiveBehaviour()};dlfViewerFullTextControl.prototype.changeActiveBehaviour=function(){if(this.activateFullTextInitially===1){this.addActiveBehaviourForSwitchOn()}else{this.addActiveBehaviourForSwitchOff()}};dlfViewerFullTextControl.prototype.addActiveBehaviourForSwitchOn=function(){var e=$("#tx-dlf-tools-fulltext");if(e.length>0){var t=$.proxy((function(e){e.preventDefault();this.activateFullTextInitially=0;if($(e.target).hasClass("active")){this.deactivate();return}this.activate()}),this);e.on("click",t);e.on("touchstart",t)}$("#tx-dlf-tools-fulltext").text(this.dic["fulltext"]).attr("title",this.dic["fulltext"]);this.activate()};dlfViewerFullTextControl.prototype.addActiveBehaviourForSwitchOff=function(){var e=$("#tx-dlf-tools-fulltext");if(e.length>0){var t=$.proxy((function(e){e.preventDefault();if($(e.target).hasClass("active")){this.deactivate();return}this.activate()}),this);e.on("click",t);e.on("touchstart",t)}$("#tx-dlf-tools-fulltext").text(this.dic["fulltext-on"]).attr("title",this.dic["fulltext-on"]);if(dlfUtils.getCookie("tx-dlf-pageview-fulltext-select")==="enabled"){this.activate()}};dlfViewerFullTextControl.prototype.onResize=function(){if(this.element!=undefined&&this.element.css("width")!=this.lastHeight){this.lastHeight=this.element.css("width");this.calculatePositions()}};dlfViewerFullTextControl.prototype.calculatePositions=function(){this.positions.length=0;let e=$("#tx-dlf-fulltextselection").children("span.textline");let t=$("#"+e[0].id).position().top;for(let i of e){let e=$("#"+i.id).position().top;this.positions[i.id]=e-t}};dlfViewerFullTextControl.prototype.handleLayersForClick=function(e){if(this.selectedFeature_){this.layers_.select.getSource().removeFeature(this.selectedFeature_)}if(e){this.layers_.hoverTextblock.getSource().clear();this.layers_.select.getSource().addFeature(e)}};dlfViewerFullTextControl.prototype.handleTextBlockElements=function(e,t,i){var n=dlfFullTextUtils.getFeature(t),o=dlfFullTextUtils.getFeature(i),r=dlfFullTextUtils.isFeatureEqual(n,e),l=dlfFullTextUtils.isFeatureEqual(o);if(!l&&!r){i.clear();if(e){i.addFeature(e)}}};dlfViewerFullTextControl.prototype.handleTextLineElements=function(e,t){var i=dlfFullTextUtils.getFeature(t);isFeatureEqualToOldHoverFeature_=dlfFullTextUtils.isFeatureEqual(i,e);if(!isFeatureEqualToOldHoverFeature_){this.removeHighlightEffect(i,t);this.addHighlightEffect(e,t)}};dlfViewerFullTextControl.prototype.removeHighlightEffect=function(e,t){if(e){var i=$("#"+e.getId());if(i.hasClass("highlight")){i.removeClass("highlight")}t.clear()}};dlfViewerFullTextControl.prototype.addHighlightEffect=function(e,t){if(e){var i=$("#"+e.getId());if(i.length>0&&!i.hasClass("highlight")){i.addClass("highlight");this.onResize();setTimeout(this.scrollToText,1e3,i,this.fullTextScrollElement,this.positions);t.addFeature(e)}}};dlfViewerFullTextControl.prototype.scrollToText=function(e,t,i){if(e.hasClass("highlight")){$(t).animate({scrollTop:i[e[0].id]},500)}};dlfViewerFullTextControl.prototype.activate=function(){var e=$("#tx-dlf-tools-fulltext");if(this.fulltextData_===undefined){this.fulltextData_=dlfFullTextUtils.fetchFullTextDataFromServer(this.url,this.image);if(this.fulltextData_!==undefined){this.layers_.textblock.getSource().addFeatures(this.fulltextData_.getTextblocks());this.layers_.textline.getSource().addFeatures(this.fulltextData_.getTextlines());if(this.fulltextData_.getTextblocks().length>0){this.layers_.select.getSource().addFeature(this.fulltextData_.getTextblocks()[0]);this.selectedFeature_=this.fulltextData_.getTextblocks()[0];this.showFulltext(this.fulltextData_.getTextblocks())}}}this.enableFulltextSelect();dlfUtils.setCookie("tx-dlf-pageview-fulltext-select","enabled");$(e).addClass("active");$(this).trigger("activate-fulltext",this);if(this.element===undefined){this.element=$("#tx-dlf-fulltextselection")}};dlfViewerFullTextControl.prototype.deactivate=function(){var e=$("#tx-dlf-tools-fulltext");this.disableFulltextSelect();dlfUtils.setCookie("tx-dlf-pageview-fulltext-select","disabled");$(e).removeClass("active");$(this).trigger("deactivate-fulltext",this)};dlfViewerFullTextControl.prototype.disableFulltextSelect=function(){this.map.un("click",this.handlers_.mapClick);this.map.un("pointermove",this.handlers_.mapHover);for(var e in this.layers_){if(this.layers_.hasOwnProperty(e)){this.map.removeLayer(this.layers_[String(e)])}}var t="fulltext-visible";$("#tx-dlf-tools-fulltext").removeClass(t);if(this.activateFullTextInitially===0){$("#tx-dlf-tools-fulltext").text(this.dic["fulltext-on"]).attr("title",this.dic["fulltext-on"])}$("#tx-dlf-fulltextselection").removeClass(t);$("#tx-dlf-fulltextselection").hide();$("body").removeClass(t)};dlfViewerFullTextControl.prototype.enableFulltextSelect=function(){this.map.on("click",this.handlers_.mapClick);this.map.on("pointermove",this.handlers_.mapHover);for(var e in this.layers_){if(this.layers_.hasOwnProperty(e)){this.map.addLayer(this.layers_[String(e)])}}var t="fulltext-visible";$("#tx-dlf-tools-fulltext").addClass(t);if(this.activateFullTextInitially===0){$("#tx-dlf-tools-fulltext").text(this.dic["fulltext-off"]).attr("title",this.dic["fulltext-off"])}$("#tx-dlf-fulltextselection").addClass(t);$("#tx-dlf-fulltextselection").show();$("body").addClass(t)};dlfViewerFullTextControl.prototype.showFulltext=function(e){if(e!==undefined){$("#tx-dlf-fulltextselection").children().remove();for(feature of e){var t=feature.get("textlines");for(textLine of t){this.appendTextLineSpan(textLine)}$("#tx-dlf-fulltextselection").append("<br /><br />")}this.calculatePositions()}};dlfViewerFullTextControl.prototype.appendTextLineSpan=function(e){var t=$('<span class="textline" id="'+e.getId()+'">');var i=e.get("content");for(item of i){var n=$('<span class="'+item.get("type")+'" id="'+item.getId()+'"/>');var o=item.get("fulltext");var r=o.split(/\n/g);for(const[e,t]of r.entries()){n.append(document.createTextNode(t));if(e<r.length-1){n.append($("<br />"))}}t.append(n)}t.append('<span class="textline" id="sp"> </span>');$("#tx-dlf-fulltextselection").append(t)};"use strict";
/**
 * (c) Kitodo. Key to digital objects e.V. <contact@kitodo.org>
 *
 * This file is part of the Kitodo and TYPO3 projects.
 *
 * @license GNU General Public License version 3 or later.
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 */var dlfFullTextUtils;dlfFullTextUtils=dlfFullTextUtils||{};dlfFullTextUtils.getFeature=function(e){return e.getFeatures().length>0?e.getFeatures()[0]:undefined};dlfFullTextUtils.isFeatureEqual=function(e,t){return e!==undefined&&t!==undefined&&e.getId()===t.getId()};dlfFullTextUtils.fetchFullTextDataFromServer=function(e,t,i){var n=$.ajax({url:e,async:false});var o=dlfUtils.exists(i)?i:undefined;return dlfFullTextUtils.parseAltoData(t,o,n)};dlfFullTextUtils.parseAltoData=function(e,t,i){var n=new dlfAltoParser(e,undefined,undefined,t),o=i.responseXML?n.parseFeatures(i.responseXML):i.responseText?n.parseFeatures(i.responseText):[];return o.length>0?o[0]:undefined};
/**
 * (c) Kitodo. Key to digital objects e.V. <contact@kitodo.org>
 *
 * This file is part of the Kitodo and TYPO3 projects.
 *
 * @license GNU General Public License version 3 or later.
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 */
var dlfViewer=function(e){this.div=dlfUtils.exists(e.div)?e.div:"tx-dlf-map";this.map=null;this.imageUrls=dlfUtils.exists(e.images)?e.images:[];this.images=[];this.fulltexts=dlfUtils.exists(e.fulltexts)?e.fulltexts:[];this.annotationContainers=dlfUtils.exists(e.annotationContainers)?e.annotationContainers:[];this.highlightFields=[];this.highlightFieldParams=undefined;this.imageManipulationControl=undefined;this.selection=undefined;this.source=undefined;this.selectionLayer=undefined;this.draw=undefined;this.source=null;this.view=null;this.ov_view=null;this.magnifierEnabled=false;this.initMagnifier=false;this.useInternalProxy=dlfUtils.exists(e.useInternalProxy)?e.useInternalProxy:false;this.init(dlfUtils.exists(e.controls)?e.controls:[])};dlfViewer.prototype.addCustomControls=function(e){var t=undefined,i=undefined,n=undefined,o=undefined,r=this.images;if(this.fulltexts[0]!==undefined&&this.fulltexts[0].length!==0&&this.fulltexts[0].url!==""&&this.images.length===1){t=new dlfViewerFullTextControl(this.map,this.images[0],this.fulltexts[0].url);i=new dlfViewerFullTextDownloadControl(this.map,this.images[0],this.fulltexts[0].url)}else{$("#tx-dlf-tools-fulltext").remove()}if(this.annotationContainers[0]!==undefined&&this.annotationContainers[0].annotationContainers!==undefined&&this.annotationContainers[0].annotationContainers.length>0&&this.images.length===1){n=new DlfAnnotationControl(this.map,this.images[0],this.annotationContainers[0]);if(t!==undefined){$(t).on("activate-fulltext",$.proxy(n.deactivate,n));$(n).on("activate-annotations",$.proxy(t.deactivate,t))}}else{$("#tx-dlf-tools-annotations").remove()}if($("#tx-dlf-tools-imagetools").length>0&&dlfUtils.isWebGLEnabled()&&this.isCorsEnabled){o=new dlfViewerImageManipulationControl({controlTarget:$(".tx-dlf-tools-imagetools")[0],layers:dlfUtils.createOl3Layers(r,"*"),map:this.map,view:dlfUtils.createOl3View(r)});if(t!==undefined){$(o).on("activate-imagemanipulation",$.proxy(t.deactivate,t));$(t).on("activate-fulltext",$.proxy(o.deactivate,o))}if(n!==undefined){$(o).on("activate-imagemanipulation",$.proxy(n.deactivate,n));$(n).on("activate-annotations",$.proxy(o.deactivate,o))}this.imageManipulationControl=o}else if($("#tx-dlf-tools-imagetools").length>0){$("#tx-dlf-tools-imagetools").addClass("deactivate")}};dlfViewer.prototype.addHighlightField=function(e,t,i,n){this.highlightFields.push(e);this.highlightFieldParams={index:t,width:i,height:n};if(this.map){this.displayHighlightWord()}};dlfViewer.prototype.createControls_=function(e,t){var i=[];for(var n in e){if(e[n]!==""){switch(e[n]){case"OverviewMap":i.push(new ol.control.OverviewMap({layers:t}));break;case"ZoomPanel":i.push(new ol.control.Zoom);break;default:break}}}return i};dlfViewer.prototype.displayHighlightWord=function(){if(!dlfUtils.exists(this.highlightLayer)){this.highlightLayer=new ol.layer.Vector({source:new ol.source.Vector,style:dlfViewerOL3Styles.wordStyle});this.map.addLayer(this.highlightLayer)}if(this.highlightFields.length>0){this.highlightLayer.getSource().clear();for(var e=0;e<this.highlightFields.length;e++){var t=this.highlightFields[e],i=[[[t[0],t[1]],[t[2],t[1]],[t[2],t[3]],[t[0],t[3]],[t[0],t[1]]]],n=this.highlightFieldParams.index===1?this.images[0].width:0;var o=dlfUtils.scaleToImageSize([new ol.Feature(new ol.geom.Polygon(i))],this.images[this.highlightFieldParams.index],this.highlightFieldParams.width,this.highlightFieldParams.height,n);this.highlightLayer.getSource().addFeatures(o)}}var r="tx_dlf[highlight_word]",l=dlfUtils.getUrlParams();if(l!==undefined&&l.hasOwnProperty(r)&&this.fulltexts[0]!==undefined&&this.fulltexts[0].url!==""&&this.images.length>0){var s=l[r],a=s.split(";"),f=dlfFullTextUtils.fetchFullTextDataFromServer(this.fulltexts[0].url,this.images[0]),d=undefined;if(this.images.length===2&this.fulltexts[1]!==undefined&&this.fulltexts[1].url!==""){var u=$.extend({},this.images[1]);u.width=u.width+this.images[0].width;d=dlfFullTextUtils.fetchFullTextDataFromServer(this.fulltexts[1].url,this.images[1],this.images[0].width)}var h=d===undefined?f.getStringFeatures():f.getStringFeatures().concat(d.getStringFeatures());a.forEach($.proxy((function(e){var t=dlfUtils.searchFeatureCollectionForText(h,e);if(t!==undefined){for(var i=0;i<t.length;i++){this.highlightLayer.getSource().addFeatures([t[i]])}}}),this))}};dlfViewer.prototype.init=function(e){if(this.imageUrls.length<=0)throw new Error("Missing image source objects.");if(this.useInternalProxy){this.isCorsEnabled=true}else{this.isCorsEnabled=dlfUtils.isCorsEnabled(this.imageUrls)}this.initLayer(this.imageUrls,this.isCorsEnabled).done($.proxy((function(t){var i=e.length>0||e[0]===""?this.createControls_(e,t):[];this.map=new ol.Map({layers:t,target:this.div,controls:i,interactions:[new ol.interaction.DragRotate,new ol.interaction.DragPan,new ol.interaction.DragZoom,new ol.interaction.PinchRotate,new ol.interaction.PinchZoom,new ol.interaction.MouseWheelZoom,new ol.interaction.KeyboardPan,new ol.interaction.KeyboardZoom,new ol.interaction.DragRotateAndZoom],keyboardEventTarget:document,view:dlfUtils.createOl3View(this.images),renderer:"canvas"});var n=dlfUtils.getCookie("tx-dlf-pageview-centerLon"),o=dlfUtils.getCookie("tx-dlf-pageview-centerLat"),r=dlfUtils.getCookie("tx-dlf-pageview-zoomLevel");if(!dlfUtils.isNullEmptyUndefinedOrNoNumber(n)&&!dlfUtils.isNullEmptyUndefinedOrNoNumber(o)&&!dlfUtils.isNullEmptyUndefinedOrNoNumber(r)){var l=this.map.getView().getCenter();if(n<2.2*l[0]&&o<-.2*l[1]&&o>2.2*l[1]){this.map.zoomTo([n,o],r)}}this.displayHighlightWord();this.addCustomControls(i);$(window).trigger("map-loadend",window);$(window).on("unload",$.proxy((function(){if(this.imageManipulationControl!==undefined&&this.imageManipulationControl.isActive()){this.imageManipulationControl.deactivate()}var e=this.map.getZoom()!==undefined?this.map.getZoom():"",t=this.map.getView().getCenter()!==undefined?this.map.getView().getCenter():["",""];dlfUtils.setCookie("tx-dlf-pageview-zoomLevel",e);dlfUtils.setCookie("tx-dlf-pageview-centerLon",t[0]);dlfUtils.setCookie("tx-dlf-pageview-centerLat",t[1])}),this))}),this));this.source=new ol.source.Vector;this.selection=new ol.interaction.DragBox({condition:ol.events.condition.noModifierKeys,style:new ol.style.Style({stroke:new ol.style.Stroke({color:[0,0,255,1]})})});this.initCropping()};dlfViewer.prototype.initLayer=function(e,t){var i=new $.Deferred,n=$.proxy((function(e,t){this.images=e;i.resolve(t)}),this),o=t?"*":undefined;dlfUtils.fetchImageData(e).done((function(e){n(e,dlfUtils.createOl3Layers(e,o))}));return i};dlfViewer.prototype.degreeToRadian=function(e){return e*(Math.PI/180)};dlfViewer.prototype.radianToDegree=function(e){return e*(180/Math.PI)};dlfViewer.prototype.activateSelection=function(){var e=this;e.resetCropSelection();this.map.addLayer(this.selectionLayer);this.map.addInteraction(this.draw)};dlfViewer.prototype.resetCropSelection=function(){this.map.removeLayer(this.selectionLayer);this.source.clear();this.setNewCropDrawer(this.source)};dlfViewer.prototype.initCropping=function(){var e=this;var t=new ol.source.Vector({wrapX:false});this.selectionLayer=new ol.layer.Vector({source:t});value="LineString";maxPoints=2;geometryFunction=function(t,i){if(!i){i=new ol.geom.Polygon(null)}var n=t[0];var o=t[1];i.setCoordinates([[n,[n[0],o[1]],o,[o[0],n[1]],n]]);var r=i.getExtent();var l=e.map.getLayers().item(0).getSource().getProjection().getExtent();var s=ol.extent.getIntersection(l,r);var a=e.map.getView().getRotation();$("#addToBasketForm #startX").val(Math.round(s[0]));$("#addToBasketForm #startY").val(Math.round(s[1]));$("#addToBasketForm #endX").val(Math.round(s[2]));$("#addToBasketForm #endY").val(Math.round(s[3]));$("#addToBasketForm #rotation").val(Math.round(e.radianToDegree(a)));return i};this.setNewCropDrawer(t)};dlfViewer.prototype.setNewCropDrawer=function(e){viewerObject=this;this.draw=new ol.interaction.Draw({source:e,type:value,geometryFunction:geometryFunction,maxPoints:maxPoints});this.draw.on("drawend",(function(e){viewerObject.map.removeInteraction(viewerObject.draw)}));this.selectionLayer=new ol.layer.Vector({source:e})};dlfViewer.prototype.addMagnifier=function(e){var t=[0,0,1e3,1e3];var i=new ol.proj.Projection({code:"kitodo-image",units:"pixels",extent:t});this.ov_view=new ol.View({projection:i,center:ol.extent.getCenter(t),zoom:3,rotation:e});this.ov_map=new ol.Map({target:"ov_map",view:this.ov_view,controls:[],interactions:[]});this.ov_map.addLayer(this.map.getLayers().getArray()[0]);var n=null;var o=this;var r=this.ov_map;this.map.on("pointermove",(function(e){n=o.map.getEventCoordinate(e.originalEvent);o.ov_view.setCenter(n)}));var l=function(e,t){var i=e.getRotation()!==t.getView().getRotation();var n=e.getCenter()!==t.getView().getCenter();if(i||n){t.getView().rotate(e.getRotation())}},s=function(e){l(e.target,r)};this.map.getView().on("change:rotation",s,this.map);l(this.map.getView(),this.ov_map);this.initMagnifier=true};dlfViewer.prototype.activateMagnifier=function(){if(!this.initMagnifier){var e=this.map.getView().getRotation();this.addMagnifier(e)}if(!this.magnifierEnabled){$("#ov_map").show();this.magnifierEnabled=true}else{$("#ov_map").hide();this.magnifierEnabled=false}};function Drag(){ol.interaction.Pointer.call(this,{handleDownEvent:Drag.prototype.handleDownEvent,handleDragEvent:Drag.prototype.handleDragEvent,handleMoveEvent:Drag.prototype.handleMoveEvent,handleUpEvent:Drag.prototype.handleUpEvent});this.coordinate_=null;this.cursor_="pointer";this.feature_=null;this.previousCursor_=undefined}